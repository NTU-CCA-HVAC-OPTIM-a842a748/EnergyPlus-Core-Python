name: Release (MacOS)

#on:
#  push:
#    tags:
#      - '*'
on: workflow_dispatch

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  main:
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.allow_failure }}
    strategy:
        # fail-fast: Default is true, switch to false to allow one platform to fail and still run others
        fail-fast: false
        matrix:
          #macos_dev_target: [10.15, 11.6, 12.1]
          macos_dev_target: [12.1, ]
          include:
          #- macos_dev_target: 10.15
          #  os: macos-11
          #  allow_failure: false
          #- macos_dev_target: 11.6
          #  os: macos-11
          #  allow_failure: false
          - macos_dev_target: 12.1
            os: macos-12
            allow_failure: false

    permissions:
        # Needed permission to upload the release asset
        contents: write

    steps:
    # TODO documentation support
    
    # NOTE checkout to ensure action can be found 
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create packages
      uses: ./.github/actions/packaging
      env:
        BUILD_COMPONENT_OPENGL: 'false'
        BUILD_COMPONENT_DOCUMENTATION: 'false'
        BUILD_COMPONENT_PYTHON_PLUGIN: 'false'

        BUILD_CONFIGURE_OPTIONS: |
          -D ENABLE_PCH:BOOL=ON
          -D BUILD_FORTRAN:BOOL=OFF

        BUILD_BUILD_OPTIONS: ''

      with:
        # TODO
        build_type: Release
        build_options: |
          --wheel

    - name: TODO Publish to GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        files: dist/*
        token: ${{ secrets.GITHUB_TOKEN }}
        release_name: Release ${{ github.event.after }}

    #- name: TODO Publish to PyPI
    #  uses: pypa/gh-action-pypi-publish@v2
    #  with:
    #    user: __token__
    #    password: ${{ secrets.PYPI_API_TOKEN }}
